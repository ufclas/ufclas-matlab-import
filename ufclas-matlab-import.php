<?php
/*
Plugin Name: UFCLAS MATLAB Import
Plugin URI: https://it.clas.ufl.edu/
Description: Imports a zip file of HTML and images generated by MATLAB and creates a new page
Version: 1.0.0
Author: Priscilla Chapman (CLAS IT)
Author URI: https://it.clas.ufl.edu/
License: GPL2
Build Date: 20170412
*/

define('UFCLAS_MATLAB_PLUGIN_DIR', plugin_dir_path( __FILE__ )); 

/**
 * Add menu item to Settings in the dashboard menu
 *
 * @since 0.0.0
 */
function ufclas_matlab_register_menu(){
	add_management_page('MATLAB Import', 'MATLAB Import', 'manage_options', 'ufclas-matlab-import', 'ufclas_matlab_page');
}
add_action('admin_menu', 'ufclas_matlab_register_menu');

/**
 * Enqueue necessary scripts and styles for the screen
 *
 * @since 0.0.0
 */
function ufclas_matlab_scripts_styles( $hook ){
	if ( $hook == 'tools_page_ufclas-matlab-import' ){
		// Required to use all media JavaScript APIs.
		wp_enqueue_media();
		
		// Add page css
		$custom_css = '#ufclas-matlab {max-width: 960px;}';
		wp_add_inline_style('dashicons', $custom_css);
	}
}
add_action('admin_enqueue_scripts', 'ufclas_matlab_scripts_styles');

/**
 * Display the import screen content
 *
 * @since 0.0.0
 */
function ufclas_matlab_page(){
	?>
	<div class="wrap" id="ufclas-matlab">
		
		<h1><?php _e('MATLAB HTML Import', 'ufclas-matlab'); ?></h1>
		
		<?php 
		// Ensure that the user has permission to upload
		if ( current_user_can( 'manage_options' ) ): 
			
			// Process the submitted form data
			ufclas_matlab_handle_upload(); 
		?>
		<h2>Step 1: Publish to HTML</h2>
		<p>By default, MATLAB creates a subfolder named <code>html</code>, which contains an HTML file and files for each .png graphic that your code creates.</p>
		
		<h2>Step 2: Zip the html Folder</h2>
		<p>Create a new .zip archive file, making sure that it contains the <code>html</code> folder. 
		<p>The import only supports .html and .png files. Any other file formats within the archive will be deleted.</p>
		
		<h2>Step 3: Upload the .zip file</h2>
		<p>The importer will create a new page under Pages and add the associated images to the Media Library.</p>
		<p><strong>Note:</strong> The imported .zip file will be deleted after upload. To upload a permanent copy, use the Media Library.</p>
		<p><strong>Note:</strong> This will overwrite any image files in the Media Library with the same name, so make sure your uploaded file names are unique.</p>
		
		<form id="ufclas-matlab-upload" class="" method="post" enctype="multipart/form-data">
			<label for="upload" class="screen-reader-text"><?php _e( 'Choose a .zip file:' ); ?></label><br />
			<input type="file" id="upload" name="import" accept="application/x-zip-compressed" />
			<?php wp_nonce_field('ufclas-matlab-upload', '_wpnonce_ufclas_matlab_upload' ); ?>
			<?php submit_button( __( 'Import', 'ufclas-matlab' ), 'primary', 'submit' ); ?>
		</form>
		
		<?php endif; ?>
		
	</div>
	<?php
}

function ufclas_matlab_handle_upload(){
	if ( empty($_FILES) ){
		return;
	}
	
	// Test whether the request includes a valid nonce
	check_admin_referer('ufclas-matlab-upload', '_wpnonce_ufclas_matlab_upload');
	
	// Make sure we have credentials before trying to access the filesystem
	$access_type = get_filesystem_method();
	
	if ( $access_type != 'direct' ){
		// No write access, warn the user with a notice
		add_action( 'admin_notices', 'ufclas_matlab_admin_notice_warning' );
	}
	else {
		$creds = request_filesystem_credentials( admin_url(), '', false, false, array());
		
		// Initialize the API
		if ( ! WP_Filesystem( $creds ) ) {
			return;
		}
		
		global $wp_filesystem;
		
		$uploaded_file = $_FILES['import'];
		$overrides = array( 'test_form' => false, 'test_type' => false );
		$file = wp_handle_upload($uploaded_file, $overrides);

		if ( isset($file['error']) ){
			wp_die( $file['error'] );
		}
		
		// Get the remote system absolute path
		$plugin_path = str_replace(ABSPATH, $wp_filesystem->abspath(), UFCLAS_MATLAB_PLUGIN_DIR);
		$export_path = $plugin_path . 'export/';
		$import_path = $export_path . 'html/';
		
		$wp_filesystem->delete( $import_path, true );
				
		if ( $result = unzip_file( $file['file'], $export_path ) !== true ){
			wp_die( __('Error: could not unzip file. Try again.', 'ufclas-matlab') );
		}
		
		// Construct the object array
		$object = array(
			'post_title' => basename($file['file']),
			'post_content' => $file['url'],
			'post_mime_type' => $file['type'],
			'guid' => $file['url'],
			'context' => 'import',
			'post_status' => 'private'
		);
		
		// Save the data in the posts table
		$upload_id = wp_insert_attachment( $object, $file['file'] );
		
		$dirlist = $wp_filesystem->dirlist( $import_path, false, true );
		$exported_files = array('html' => '', 'images' => array() );
		
		foreach ( $dirlist as $file_name => $file_data ){
			if ( $file_data['type'] == 'f' ){
				
				$name = $file_data['name'];
				
				if ( substr( $name, -5 ) == '.html' ){
					$exported_files['html'] = $name;
				}
				elseif ( substr( $name, -4 ) == '.png' ) {
					$exported_files['images'][] = $name;
				}
			}
		}
		
		$html_path = $import_path . '/' . $exported_files['html'];
		$html_content = $wp_filesystem->get_contents( $html_path );
		
		$dom = new DOMDocument();
		$dom->loadHTML($html_content);
		$node_list = $dom->getElementsByTagName('div');
		$new_dom = new DOMDocument();
		$new_dom->formatOutput = true;
		$new_div = $new_dom->createElement('div');
		$new_div->setAttribute( 'id', 'matlab-import' );
		$new_div->appendChild( $new_dom->importNode($node_list->item(0), true) );
		$new_dom->appendChild( $new_div );

		$post_content = $new_dom->saveHTML();
		
		$html_page_id = wp_insert_post( array(
			'post_title' => $exported_files['html'],
			'post_content' => $post_content,
			'post_type' => 'page',
			'post_author' => get_current_user_id(),
			'post_status' => 'publish'
		) );
		
		foreach ( $exported_files['images'] as $image ){
			$image_path = $import_path . '/' . $image;
			$image_type = wp_check_filetype( basename( $image_path ) );
			$image_upload_dir = wp_upload_dir();
			$image_upload_path = $image_upload_dir['path'] . '/' . $image;
			$image_upload_url = $image_upload_dir['url'] . '/' . $image;
			
			$wp_filesystem->move($image_path, $image_upload_path, true );
			
			$attachment = array(
				'post_title' => preg_replace( '/\.[^.]+$/', '', $image ),
				'post_content' => '',
				'post_mime_type' => $image_type['type'],
				'post_status' => 'inherit',
				'guid' => $image_upload_url
			);
			
			require_once( ABSPATH . 'wp-admin/includes/image.php' );
			
			$attach_id = wp_insert_attachment( $attachment, $image_upload_path, $html_page_id );
			$attach_data = wp_generate_attachment_metadata( $attach_id, $image_upload_path );
			wp_update_attachment_metadata( $attach_id, $attach_data );
			
			$image_url = wp_get_attachment_url( $attach_id, 'full' );
			
			$post_content = str_replace( $image, $image_upload_url, $post_content );
		}
		
		wp_update_post( array( 'ID' => $html_page_id, 'post_content' => $post_content ) );
		wp_delete_attachment( $upload_id );
		$wp_filesystem->delete( $import_path, true );
		
		
	}
}

function ufclas_matlab_admin_notice_warning(){
	?>
    <div class="notice notice-warning is-dismissible">
        <p><?php _e( 'You do not have access to modify files.', 'ufclas-matlab' ); ?></p>
    </div>
    <?php
}